---
title: JS垃圾回收机制
tags: [JavaScript,GC]
category: JavaScript
date: 2020-3-17 12:59
---
# JS垃圾回收机制

## 前言
这两天面试问到了 JS 垃圾回收机制，对我来说就是一问三不知啊，所以决定好好整理一下。

## 基础
对于大部分程序语言来说对于内存的管理大概如下：
 1. 分配所需要的内存
 2. 使用分配到的内存
 3. 不用的时候将其释放

对于 JavaScript 来说，在定义变量的时候就完成了内存分配，但是难点往往就在于如何能在这个变量不被需要的时候释放这部分内存，JavaScript 也是如此，只能通过有限制的方法解决主要的问题。

## 垃圾回收

### 引用
在内存管理上，引用是一个十分重要的概念，如果对象 A 有能访问对象 B 的权限，那么叫做对象 A 引用对象 B。
### 垃圾回收方法
#### 引用计数
这是最基本的垃圾回收算法。其确定对象是否不再被需要的方法就是“如果没有对象引用它，那么该对象将会被回收”，例如：
```javascript
var obj1 = {
    name : 'fawen'
};
// 创建了对象，这个对象被赋值给 obj，即 obj 引用了该对象
var obj2 = obj1;
// 赋值给 obj2，这个时候对象又多了一个引用
obj1 = null;
// 这个时候，obj1 不再引用对象，对象只被 obj2 引用
obj2 = null
// 没有人在引用这个对象了，它可以被垃圾回收
```

这种方式在循环应用的情况下会有问题，及两个对象互相引用：
```javascript
function fun(){
    var obj1 = {};
    var obj2 = {};
    obj1.fawen = obj2;
    obj2.fawen = obj1;
    // obj1 = null;
    // obj2 = null;
    // 只有手动设为空了之后才能被回收
}
fun()；
```
函数执行完成后本应该回收 obj1 和 obj2，但是计数引用一看，这两个对象被引用次数都不等于零，就没有回收，这时候就有可能发生内存泄露。对于这种情况，就需要手动将值设置成空；

#### 标记-清除算法
这是当前最常见的垃圾回收方法，所有现代浏览器都使用了标记-清除算法。在标记-清除算法中，“一个对象不再被需要”被定义为了“对象是否可以获得”。

标记清除的意思就是，垃圾回收期定期从根对象开始（对于 JavaScript 来说，这个对象是 `window`），查找这些对象引用的对象，再找这些对象引用的对象，如此循环，这样一来，我们就获得了实际上正在被真正引用的对象，对这些对象做一个标记，然后在清除这些没有被标记的对象，这时候循环引用不在是问题，因为只要循环引用的对象从`window`出发无法被获取，那么这些实际上没有用的对象也将被清除。